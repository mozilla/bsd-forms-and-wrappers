<!-- =================== Below form content STARTS =================== -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://sendto.mozilla.org/page/-/protect-net-neutrality/js/parsley.min.js"></script>
<script>

(function(){

  var $bsdForm = $("#signup"); // BSD autogenerated form
  var $theForm = $("#petition-signup-form"); // our beautified form
  var $stateDropdown = $theForm.find("select[name='state_cd']");
  var REDIRECT_URL = "https://sendto.mozilla.org/page/s/FCCvote-net-neutrality-thanks"; // no way to this value from BSD directly, have to use hardcoded url here

  // ***********************************************
  // Remove the BSD generated form from DOM
  // ***********************************************
  $(window).on("load", function () {
    $bsdForm.remove();
  });


  // ***********************************************
  // Display countdown counter
  // ***********************************************
  // the FCC votes in EST (Washington DC) and the date of the vote is February 26th.
  // So 8am EST on Feb 26th is a good date to countdown to
  var FORM_DUE_TIME = 1424955600000;  // countdown to Feb. 26 8am EST = 1424955600000 (Unix)

  var updateCountdown = function() {
    var userLocalTime = (new Date()).getTime();
    var daysAway = Math.floor( (FORM_DUE_TIME - userLocalTime) / 24 / 60 / 60 / 1000 );
    document.querySelector("#countdown-days span").innerHTML = daysAway;
  }
  setInterval(updateCountdown, 60*1000); // in milliseconds. update counter every min

  updateCountdown();

  // ***********************************************
  // Parsley Settings, Form Validation, & Form Validation
  // ***********************************************

  $("#one-line-error").hide();

  window.ParsleyValidator
    // Check `zip code` is a valid US zip code
    .addValidator('checkZip', function (value, requirement) {
      var reg = /^\d{5}([\-]\d{4})?$/;
      return (value.match(reg) && value.match(reg).length > 0 );
    }, 10);


  $theForm.parsley().subscribe('parsley:form:validated', function (formInstance) {
    if (formInstance.submitEvent !== undefined) {
      formInstance.submitEvent.preventDefault();
    }
    if (!formInstance.isValid()) {
      formInstance.submitEvent.preventDefault();
    } else {
      // ***********************************************
      // Form Submission
      // ***********************************************

      function submissionErrorHandler(XHR, textStatus, error) {
        $('#one-line-error').text("Something seems to have gone wrong. Please try again later").show();
      }

      function submitSuccess(data, textStatus, XHR) {
        var redirectUrlWithCountry = REDIRECT_URL + "?" + "country=" + $theForm.find("input[name='country']").val();
        if (window.location.assign) {
          window.location.assign(redirectUrlWithCountry);
        } else {
          window.location = redirectUrlWithCountry;
        }
      }

      function submitError(XHR, textStatus, error) {
      }

      var submitTheForm = $.ajax($theForm.prop("action"), {
        type: "POST",
        data: $theForm.serialize(),
        statusCode: {
          400: submissionErrorHandler,
          500: submissionErrorHandler
        }

      });

      submitTheForm.error(submitError).success(submitSuccess);
    }
  });


  var toggleOneLineError = function() {
    var numErrors = $(".parsley-error").length;
    if ( numErrors > 0 ) {
      $("#one-line-error").show();
    } else {
      $("#one-line-error").hide();
    }
  };

  var updateDropdownTextColor =  function(event) {
    var $target = $(event.target);
    var selected = $target.val();
    if ( selected ){
      $target.addClass("defaultTextColor");
    } else {
      $target.removeClass("defaultTextColor");
    }
  }

  updateDropdownTextColor($stateDropdown);

  $stateDropdown.on("change", updateDropdownTextColor);

  $theForm.parsley().subscribe('parsley:field:validated', function (fieldInstance) {
    toggleOneLineError();
  });


})();

</script>

<!-- =================== Below form content ENDS =================== -->
