<!-- =================== Below form content STARTS =================== -->

<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top" id="paypal-one-time">
  <input type="hidden" name="cmd" value="_donations">
  <input type="hidden" name="business" value="44ZHAVWJHTK2N">
  <input type="hidden" name="lc" value="US">
  <input type="hidden" name="item_name" value="Mozilla Foundation">
  <input type="hidden" name="no_note" value="1">
  <input type="hidden" name="no_shipping" value="1">
  <input type="hidden" name="rm" value="1">
  <!-- Donation Amount -->
  <input type="hidden" name="amount" value="3">
  <input type="hidden" name="return" value="https://sendto.mozilla.org/page/s/">
  <input type="hidden" name="currency_code" value="USD">
  <input type="hidden" name="bn" value="PP-DonationsBF:maker-party-donate-button.png:NonHosted">
</form>

<form action="https://www.paypal.com/cgi-bin/webscr" method="post" id="paypal-recurring">
  <input type="hidden" name="cmd" value="_xclick-subscriptions">
  <input type="hidden" name="business" value="44ZHAVWJHTK2N">
  <input type="hidden" name="lc" value="US">
  <input type="hidden" name="item_name" value="Mozilla Foundation Recurring Donation">
  <input type="hidden" name="no_note" value="1">
  <input type="hidden" name="no_shipping" value="2">
  <input type="hidden" name="return" value="https://sendto.mozilla.org/page/s/">
  <input type="hidden" name="src" value="1">
  <input type="hidden" name="p3" value="1">
  <input type="hidden" name="currency_code" value="USD">
  <input type="hidden" name="bn" value="PP-SubscriptionsBF:maker-party-donate-button.png:NonHosted">
  <input type="hidden" name="t3" value="M">
  <input name="srt" type="hidden" value="0">
  <!-- Donation Amount -->
  <input type="hidden" name="a3" value="3">
</form>


<script src="https://www.mozilla.org/tabzilla/media/js/tabzilla.js"></script>
<script>
var
    $bsdForm = $("form#contribution"),
    $theForm = $("#donation-form");

  // To make the page show properly on mobile
$("head").append("<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">");

  // ***********************************************
  // UI related
  // ***********************************************
  $(".cc-additional-info").hide();
  $(".hint-msg").hide();

  $("#donation-form input, #donation-form select").focus(function() {
    $(this).siblings("i.fa.field-icon").addClass("icon-in-focus");
  });
  $("#donation-form input, #donation-form select").blur(function() {
    $(this).siblings("i.fa.field-icon").removeClass("icon-in-focus");
  });

  $("#payment-type-row label").click(function() {
    // reset
    $(".cc-additional-info").hide();
    // toggle corresponding section
    var paymentType = $(this).attr("for");
    if ( paymentType == "payment-cc" ) {
      $(".cc-additional-info").slideDown( "slow" );
    }
  });

  $("input#amount-other + label + input[type=\"text\"]").focus(function() {
    $(this).prevAll("input[type=\"radio\"]").click();
  });

  $("i.hint").click(function() {
    $(this).toggleClass("on");
    $(this).parents(".hint-msg-parent").find(".hint-msg").toggle();
  });


  // ***********************************************
  // Changing credit card logos on click / hover
  // Not an ideal way to swap the images. Probably should use CSS sprite when we get a chance
  // ***********************************************
  function coloredCCLogos() {
    $("#visa-logo").attr("src", "https://sendto.mozilla.org/page/-/donation_form/img/Visa.png");
      $("#mc-logo").attr("src", "https://sendto.mozilla.org/page/-/donation_form/img/MasterCard.png");
  }

  function whiteCCLogos() {
    $("#visa-logo").attr("src", "https://sendto.mozilla.org/page/-/donation_form/img/Visa-white.png");
      $("#mc-logo").attr("src", "https://sendto.mozilla.org/page/-/donation_form/img/MasterCard-white.png");
  }

  $("input[name='payment-type']").change(function() {
    var selected = $(this).val();
    if ( selected == "cc" ) {
      whiteCCLogos();
    } else {
      coloredCCLogos();
    }
  });

  $("label[for='payment-cc']").mouseover(function (){
    whiteCCLogos();
  });

  $("label[for='payment-cc']").mouseout(function (){
    coloredCCLogos();
  });

  // ***********************************************
  // Generate state & country dropdown.
  // This basically copies the BSD generated DOM.
  // ***********************************************
  function generateCountryDropdown() {
    var cloned = $bsdForm.find("select[name='country']").clone();
    $theForm.find("select[name='country']").html(cloned.html());
    $theForm.find("select[name='country'] option:selected").removeAttr("selected");
    $theForm.find("select[name='country'] option:first-child").attr("selected","selected").html("Country");
    $theForm.find("select[name='country']").change(function (){
      var selected = $(this).val();
      console.log(selected);
      if ( selected ){
        $(this).addClass("normalTextColor");
      } else {
        $(this).removeClass("normalTextColor");
      }
    });
  }
  generateCountryDropdown();

  $theForm.find('select[name="state_cd"]').change(function () {
    var selected = $(this).val();
    if ( selected ){
      $(this).addClass("normalTextColor");
    } else {
      $(this).removeClass("normalTextColor");
    }
  })


  // ***********************************************
  // Extract BSD form meta and insert to our form
  // ***********************************************
  function insertFormMetaDOM() {
    // the following is an array of all the meta form field names that came with the BSD generated form
    // API doc here: https://github.com/bluestatedigital/bsd-developer-docs/blob/master/bsd-donate-api/README.md
    var bsdFormMetaName = [
                        "submission_key",
                        "http_referer",
                        "event_attendee_id",
                        "outreach_page_id",
                        "stg_signup_id",
                        "mailing_link_id",
                        "mailing_recipient_id",
                        "match_campaign_id",
                        "match_is_pledge",
                        "pledge_is_convert",
                        "contributor_key",
                        "quick_donate_populated",
                        "device_fingerprint",
                        "default_country",
                        "cc_number_ack",
                        "ach_account_number_ack",
                        "k-ris-sid",
                      ];

    var metaFieldsDOM = "";
    var slug = window.location.pathname.split('/');
    slug = slug.reverse();

    if (slug[0] === '') {
      slug.shift();
    }

    $('input[name="slug"]').attr('value', slug[0]);

    $.each(bsdFormMetaName, function( index, value ) {
      var field = $bsdForm.find("[name='"+ value + "']").clone();
      metaFieldsDOM += field[0].outerHTML;
    });

    $theForm.prepend(metaFieldsDOM);
    console.log("copy cloned fields done");
  }
  insertFormMetaDOM();


  // ***********************************************
  // Remove the BSD generated form from DOM
  // ***********************************************
  $bsdForm.remove();

  // ***********************************************
  // Update Donate button to make it show the selected donation amount
  // ***********************************************
  var updateDonateButtonText = function(event) {
    var amountSelected = $(this).val();
    console.log(amountSelected);
    var buttonText;
    if ( amountSelected == "other" ) {
      amountSelected = $theForm.find("[name='donation_amount_other']").val();
    }
    buttonText = amountSelected ? "Donate $" + amountSelected + " now" : "Donate now";
    $("#donate-btn").attr("value", buttonText);
    $('#paypal-one-time').find('[name="donation_amount"]').attr('value', amountSelected);
    $('#paypal-recurring').find('[name="a3"]').attr('value', amountSelected);
  };

  $theForm.find("[name='donation_amount']").change(updateDonateButtonText);
  $theForm.find("[name='donation_amount_other']").keyup(updateDonateButtonText);
  $theForm.find("[name='donation_amount_other']").keydown(function(event) {
    // console.log(event.keyCode);
    var functionKeys = [46, 8, 9, 27, 13, 110, 190]; // backspace, delete, tab, escape, enter and .
    var numberKeys = [ 48, 49, 50, 51, 52, 53, 54, 55, 56, 57 ]; // numbers
    var allowed = functionKeys.concat(numberKeys);
    // console.log(allowed.indexOf(event.keyCode));
    if ( allowed.indexOf(event.keyCode) === -1 ) {
      event.preventDefault();
    }
  });


  // ***********************************************
  // Parsley.js setting & client side validation etc
  // API: http://parsleyjs.org/doc/
  // ***********************************************
  var regVisa = /^(?:4[0-9]{12}(?:[0-9]{3})?)$/;
  var regMC = /^(?:5[1-5][0-9]{14})$/;

  window.ParsleyConfig = {};

  window.ParsleyValidator
    // Check `other amount` is valid
    // .addValidator('checkAmount', function (value, requirement) {
    //   return;
    // }, 10)
    // Visa and Master Card client side validation
    .addValidator('visaMcCardNum', function (value, requirement) {
      return (value.match(regVisa) && value.match(regVisa).length > 0 )
              || (value.match(regMC) && value.match(regMC).length > 0 );
    }, 10)
    // Credit card expirary date validation
    .addValidator('ccExpirary', function (value, requirement) {
      var reg = /(0[1-9]|1[0-2])\/[0-9]{2}/;
      return (value.match(reg) && value.match(reg).length > 0 );
    }, 10);

  var parsleyForm = $theForm.parsley();

  parsleyForm.subscribe("parsley:form:validate", function (formInstance) {
    formInstance.submitEvent.preventDefault();

    var
        $donateButton = $('#donate-btn'),
        donateButtonText = $donateButton.val();

    $donateButton.prop('disabled', true).val('Submitting…');

    if ($('input[name="payment-type"]:checked').val() === 'paypal') {
      if ($('input[name="recurring_acknowledge"]:checked').val() == '0') {
        $('#paypal-one-time').submit();
      } else {
        $('#paypal-recurring').submit();
      }
    } else {
      // Show additional fields if amount has been selected & the payment type is credit card
      var amount = formInstance.isValid("donation_amount", true);
      var paymentType = formInstance.isValid("payment-type", true);
      if (!$(".cc-additional-info").is(":visible") && amount && paymentType) {
        $(".cc-additional-info").slideDown("slow");
      }

      var isFormValid = formInstance.isValid();
      console.log(isFormValid);
      if (isFormValid) {

        function findCCType(ccNum) {
          if (ccNum.match(regVisa)) {
            return 'vs';
          } else if (ccNum.match(regMC)) {
            return 'mc';
          } else {
            return null;
          }
        }

        function splitExpirationDate() {
          var
              $exp = $('input[name="cc_expir_group"]'),
              exp = $exp.val(),
              exp = exp.split('/');

          $('input[name="cc_expir_month"]').attr('value', exp[0] );
          $('input[name="cc_expir_year"]').attr('value', exp[1]);
        }

        function prepDonationAmount() {
          $('input[name="amount_other"]').attr('value',
              $('input[name="donation_amount_other"]').val() !== '' ? $('input[name="donation_amount_other"]').val() : $('input[name="donation_amount"]:checked').val()
          )
        }

        prepDonationAmount();
        splitExpirationDate();
        $('input[name="cc_type_cd"]').attr('value', findCCType($('input[name="cc_number"]').val()));

        var submitDonation = $.ajax('/page/cde/Api/Charge/v1', {
          type: 'POST',
          data: $theForm.serializeArray(),
          statusCode: {
            400: function (XHR, textStatus, error) {
              switch (XHR.responseJSON.code) {
              case 'duplicate':
                $('#one-line-error').text('Looks like we already have your donation—please refresh if you wish to donate again.').show();
                break;
              case 'gateway':
                switch (XHR.responseJSON.gateway_response.status) {
                case 'decline' || 'failure':
                  $('#one-line-error').text('Sorry, your card was declined. Please try another.').show();
                  break;
                }
              case 'unknown':
                  $('#one-line-error').text('Something went wrong with your transaction. Please try again later.').show();
                  break;
              break;
              default :
                $('#one-line-error').text('Something seems to have gone wrong. Please try again later.').show();
              }
            },
            500: function (XHR, textStatus, error) {
              $('#one-line-error').text('Something went wrong with your transaction. Please try again later.').show();
            }
          }
        });

        function submitSuccess(data, textStatus, XHR) {
          if (window.location.assign) {
            window.location.assign(data.redirect_url);
          } else {
            window.location = data.redirect_url;
          }
        }

        function submitError(XHR, textStatus, error) {
          $donateButton.prop('disabled', false).val(donateButtonText);
        }

        submitDonation.error(submitError).success(submitSuccess);

        $("#one-line-error").hide();
      } else {
        $donateButton.prop('disabled', false).val(donateButtonText);
        $("#one-line-error").show();
      }
    }
  });

</script>
<!-- =================== Below form content ENDS =================== -->
